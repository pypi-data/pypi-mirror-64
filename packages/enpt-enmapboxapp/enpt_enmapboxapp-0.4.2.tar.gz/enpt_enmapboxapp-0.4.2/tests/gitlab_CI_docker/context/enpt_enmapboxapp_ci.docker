FROM gms_base_centos:0.3

# install Xvfb to be able to assign a DISPLAY for Qt tests
RUN yum install -y xorg-x11-server-Xvfb

# copy some needed stuff to /root
COPY *.yml /root/

# update Miniconda
ENV miniconda_dl 'Miniconda3-latest-Linux-x86_64.sh'
RUN /bin/bash -i -c "\
    rm -rf /root/miniconda3 ; \
    wget https://repo.continuum.io/miniconda/$miniconda_dl -P /root/ ; \
    bash -i /root/$miniconda_dl -b ; \
    rm -f /root/$miniconda_dl"

# update the ci_env environment (that already contains all packages installed via 'docker_pyenvs' repo)
# -> also include packages for conda deployment and upload
RUN /bin/bash -i -c "\
    source /root/miniconda3/bin/activate ; \
    conda update -n base -c defaults conda ; \
    source activate ci_env; \
    conda env update -n ci_env -f /root/environment_enpt_enmapboxapp.yml"

# copy enmapbox, enpt and sicor code to /tmp
COPY enmapbox /tmp/enmapbox
COPY enpt /tmp/enpt
COPY sicor /tmp/sicor

# install enmapbox (in pip development mode)
RUN bash -i -c "\
    source /root/miniconda3/bin/activate ci_env ; \
    cd /tmp/enmapbox/ ; \
    pip install -r https://bitbucket.org/hu-geomatics/enmap-box/raw/develop/requirements.txt ; \
    pip install -e . ; \
    conda list"

# install enpt (into separate conda environment; in pip development mode)
RUN bash -i -c "\
    source /root/miniconda3/bin/activate ; \
    conda env update -f /tmp/enpt/tests/gitlab_CI_docker/context/environment_enpt.yml ; \
    source activate enpt ; \
    cd /tmp/sicor/ ; \
    pip install -e . ; \
    cd /tmp/enpt/ ; \
    pip install -e . ; \
    conda list"
